<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.11"/>
<title>LIKWID: LIKWID API in a C/C++ application</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { init_search(); });
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="logo.png"/></td>
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">LIKWID
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.11 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li class="current"><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li><a href="files.html"><span>Files</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

</div><!-- top -->
<div class="header">
  <div class="headertitle">
<div class="title">LIKWID API in a C/C++ application </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><div class="fragment"><div class="line"><span class="comment">/*</span></div><div class="line"><span class="comment"> * =======================================================================================</span></div><div class="line"><span class="comment"> *</span></div><div class="line"><span class="comment"> *      Filename:  C-likwidAPI.c</span></div><div class="line"><span class="comment"> *</span></div><div class="line"><span class="comment"> *      Description:  Example how to use the LIKWID API in C/C++ applications</span></div><div class="line"><span class="comment"> *</span></div><div class="line"><span class="comment"> *      Version:   4.3.2</span></div><div class="line"><span class="comment"> *      Released:  12.04.2018</span></div><div class="line"><span class="comment"> *</span></div><div class="line"><span class="comment"> *      Author:  Thomas Roehl (tr), thomas.roehl@googlemail.com</span></div><div class="line"><span class="comment"> *      Project:  likwid</span></div><div class="line"><span class="comment"> *</span></div><div class="line"><span class="comment"> *      Copyright (C) 2018 RRZE, University Erlangen-Nuremberg</span></div><div class="line"><span class="comment"> *</span></div><div class="line"><span class="comment"> *      This program is free software: you can redistribute it and/or modify it under</span></div><div class="line"><span class="comment"> *      the terms of the GNU General Public License as published by the Free Software</span></div><div class="line"><span class="comment"> *      Foundation, either version 3 of the License, or (at your option) any later</span></div><div class="line"><span class="comment"> *      version.</span></div><div class="line"><span class="comment"> *</span></div><div class="line"><span class="comment"> *      This program is distributed in the hope that it will be useful, but WITHOUT ANY</span></div><div class="line"><span class="comment"> *      WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS FOR A</span></div><div class="line"><span class="comment"> *      PARTICULAR PURPOSE.  See the GNU General Public License for more details.</span></div><div class="line"><span class="comment"> *</span></div><div class="line"><span class="comment"> *      You should have received a copy of the GNU General Public License along with</span></div><div class="line"><span class="comment"> *      this program.  If not, see &lt;http://www.gnu.org/licenses/&gt;.</span></div><div class="line"><span class="comment"> *</span></div><div class="line"><span class="comment"> * =======================================================================================</span></div><div class="line"><span class="comment"> */</span></div><div class="line"></div><div class="line"><span class="preprocessor">#include &lt;stdlib.h&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;stdio.h&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;unistd.h&gt;</span></div><div class="line"></div><div class="line"><span class="preprocessor">#include &lt;likwid.h&gt;</span></div><div class="line"></div><div class="line"></div><div class="line"><span class="keywordtype">int</span> main(<span class="keywordtype">int</span> argc, <span class="keywordtype">char</span>* argv[])</div><div class="line">{</div><div class="line">    <span class="keywordtype">int</span> i, j;</div><div class="line">    <span class="keywordtype">int</span> err;</div><div class="line">    <span class="keywordtype">int</span>* cpus;</div><div class="line">    <span class="keywordtype">int</span> gid;</div><div class="line">    <span class="keywordtype">double</span> result = 0.0;</div><div class="line">    <span class="keywordtype">char</span> estr[] = <span class="stringliteral">&quot;L2_LINES_IN_ALL:PMC0,L2_TRANS_L2_WB:PMC1&quot;</span>;</div><div class="line">    <span class="comment">//perfmon_setVerbosity(3);</span></div><div class="line">    <span class="comment">// Load the topology module and print some values.</span></div><div class="line">    err = <a class="code" href="group__CPUTopology.html#gaed8402831b977e056e599efdfd81c69f">topology_init</a>();</div><div class="line">    <span class="keywordflow">if</span> (err &lt; 0)</div><div class="line">    {</div><div class="line">        printf(<span class="stringliteral">&quot;Failed to initialize LIKWID&#39;s topology module\n&quot;</span>);</div><div class="line">        <span class="keywordflow">return</span> 1;</div><div class="line">    }</div><div class="line">    <span class="comment">// CpuInfo_t contains global information like name, CPU family, ...</span></div><div class="line">    <a class="code" href="structCpuInfo.html">CpuInfo_t</a> info = <a class="code" href="group__CPUTopology.html#gaf188f8c832d01a0695d7305d7a8e0914">get_cpuInfo</a>();</div><div class="line">    <span class="comment">// CpuTopology_t contains information about the topology of the CPUs.</span></div><div class="line">    <a class="code" href="structCpuTopology.html">CpuTopology_t</a> topo = <a class="code" href="group__CPUTopology.html#gaf36d11c3145ac2a7d93affda4b5fe5c4">get_cpuTopology</a>();</div><div class="line">    <span class="comment">// Create affinity domains. Commonly only needed when reading Uncore counters</span></div><div class="line">    <a class="code" href="group__AffinityDomains.html#ga63b1de2bbb2c42f4254718bc17e4a524">affinity_init</a>();</div><div class="line"></div><div class="line">    printf(<span class="stringliteral">&quot;Likwid example on a %s with %d CPUs\n&quot;</span>, info-&gt;<a class="code" href="structCpuInfo.html#a543077bafdaaa87a293df1dcb1e9f21d">name</a>, topo-&gt;<a class="code" href="structCpuTopology.html#a9171d1006dc1d1b5f0f6e71ec799c345">numHWThreads</a>);</div><div class="line"></div><div class="line">    cpus = (<span class="keywordtype">int</span>*)malloc(topo-&gt;<a class="code" href="structCpuTopology.html#a9171d1006dc1d1b5f0f6e71ec799c345">numHWThreads</a> * <span class="keyword">sizeof</span>(<span class="keywordtype">int</span>));</div><div class="line">    <span class="keywordflow">if</span> (!cpus)</div><div class="line">        <span class="keywordflow">return</span> 1;</div><div class="line"></div><div class="line">    <span class="keywordflow">for</span> (i=0;i&lt;topo-&gt;<a class="code" href="structCpuTopology.html#a9171d1006dc1d1b5f0f6e71ec799c345">numHWThreads</a>;i++)</div><div class="line">    {</div><div class="line">        cpus[i] = topo-&gt;<a class="code" href="structCpuTopology.html#ad3617418aabe270261f1e11bd6666882">threadPool</a>[i].<a class="code" href="structHWThread.html#a4ade3a332e66c6f273344bd770f66b0d">apicId</a>;</div><div class="line">    }</div><div class="line"></div><div class="line">    <span class="comment">// Must be called before perfmon_init() but only if you want to use another</span></div><div class="line">    <span class="comment">// access mode as the pre-configured one. For direct access (0) you have to</span></div><div class="line">    <span class="comment">// be root.</span></div><div class="line">    <span class="comment">//accessClient_setaccessmode(0);</span></div><div class="line"></div><div class="line">    <span class="comment">// Initialize the perfmon module.</span></div><div class="line">    err = <a class="code" href="group__PerfMon.html#ga97c05f43170dfd8b52c9a3f306f25edd">perfmon_init</a>(topo-&gt;<a class="code" href="structCpuTopology.html#a9171d1006dc1d1b5f0f6e71ec799c345">numHWThreads</a>, cpus);</div><div class="line">    <span class="keywordflow">if</span> (err &lt; 0)</div><div class="line">    {</div><div class="line">        printf(<span class="stringliteral">&quot;Failed to initialize LIKWID&#39;s performance monitoring module\n&quot;</span>);</div><div class="line">        <a class="code" href="group__CPUTopology.html#ga172163ecf6b848305009cd73ff3607b2">topology_finalize</a>();</div><div class="line">        <span class="keywordflow">return</span> 1;</div><div class="line">    }</div><div class="line"></div><div class="line">    <span class="comment">// Add eventset string to the perfmon module.</span></div><div class="line">    gid = <a class="code" href="group__PerfMon.html#gac930dc66a0e3d662ded0a5c9cd6ab627">perfmon_addEventSet</a>(estr);</div><div class="line">    <span class="keywordflow">if</span> (gid &lt; 0)</div><div class="line">    {</div><div class="line">        printf(<span class="stringliteral">&quot;Failed to add event string %s to LIKWID&#39;s performance monitoring module\n&quot;</span>, estr);</div><div class="line">        <a class="code" href="group__PerfMon.html#gac04bee1a0b2a5729a332c356c04a3392">perfmon_finalize</a>();</div><div class="line">        <a class="code" href="group__CPUTopology.html#ga172163ecf6b848305009cd73ff3607b2">topology_finalize</a>();</div><div class="line">        <span class="keywordflow">return</span> 1;</div><div class="line">    }</div><div class="line"></div><div class="line">    <span class="comment">// Setup the eventset identified by group ID (gid).</span></div><div class="line">    err = <a class="code" href="group__PerfMon.html#ga6dd54abbd5fb77d5d5b3301a01094502">perfmon_setupCounters</a>(gid);</div><div class="line">    <span class="keywordflow">if</span> (err &lt; 0)</div><div class="line">    {</div><div class="line">        printf(<span class="stringliteral">&quot;Failed to setup group %d in LIKWID&#39;s performance monitoring module\n&quot;</span>, gid);</div><div class="line">        <a class="code" href="group__PerfMon.html#gac04bee1a0b2a5729a332c356c04a3392">perfmon_finalize</a>();</div><div class="line">        <a class="code" href="group__CPUTopology.html#ga172163ecf6b848305009cd73ff3607b2">topology_finalize</a>();</div><div class="line">        <span class="keywordflow">return</span> 1;</div><div class="line">    }</div><div class="line">    <span class="comment">// Start all counters in the previously set up event set.</span></div><div class="line">    err = <a class="code" href="group__PerfMon.html#gaae53f040d3c6d1ca2ccc0bb6d5d654cf">perfmon_startCounters</a>();</div><div class="line">    <span class="keywordflow">if</span> (err &lt; 0)</div><div class="line">    {</div><div class="line">        printf(<span class="stringliteral">&quot;Failed to start counters for group %d for thread %d\n&quot;</span>,gid, (-1*err)-1);</div><div class="line">        <a class="code" href="group__PerfMon.html#gac04bee1a0b2a5729a332c356c04a3392">perfmon_finalize</a>();</div><div class="line">        <a class="code" href="group__CPUTopology.html#ga172163ecf6b848305009cd73ff3607b2">topology_finalize</a>();</div><div class="line">        <span class="keywordflow">return</span> 1;</div><div class="line">    }</div><div class="line">    <span class="comment">// Perform something</span></div><div class="line">    sleep(10);</div><div class="line">    <span class="comment">// Stop all counters in the previously started event set.</span></div><div class="line">    err = <a class="code" href="group__PerfMon.html#ga30e98c5d44ffa5718e67fe67a39a02c6">perfmon_stopCounters</a>();</div><div class="line">    <span class="keywordflow">if</span> (err &lt; 0)</div><div class="line">    {</div><div class="line">        printf(<span class="stringliteral">&quot;Failed to stop counters for group %d for thread %d\n&quot;</span>,gid, (-1*err)-1);</div><div class="line">        <a class="code" href="group__PerfMon.html#gac04bee1a0b2a5729a332c356c04a3392">perfmon_finalize</a>();</div><div class="line">        <a class="code" href="group__CPUTopology.html#ga172163ecf6b848305009cd73ff3607b2">topology_finalize</a>();</div><div class="line">        <span class="keywordflow">return</span> 1;</div><div class="line">    }</div><div class="line"></div><div class="line"></div><div class="line">    <span class="comment">// Print the result of every thread/CPU for all events in estr.</span></div><div class="line">    <span class="keywordtype">char</span>* ptr = strtok(estr,<span class="stringliteral">&quot;,&quot;</span>);</div><div class="line">    j = 0;</div><div class="line">    <span class="keywordflow">while</span> (ptr != NULL)</div><div class="line">    {</div><div class="line">        <span class="keywordflow">for</span> (i = 0;i &lt; topo-&gt;<a class="code" href="structCpuTopology.html#a9171d1006dc1d1b5f0f6e71ec799c345">numHWThreads</a>; i++)</div><div class="line">        {</div><div class="line">            result = <a class="code" href="group__PerfMon.html#gaf029b4229deeeb1f2a8691e9b3a14c25">perfmon_getResult</a>(gid, j, i);</div><div class="line">            printf(<span class="stringliteral">&quot;Measurement result for event set %s at CPU %d: %f\n&quot;</span>, ptr, cpus[i], result);</div><div class="line">        }</div><div class="line">        ptr = strtok(NULL,<span class="stringliteral">&quot;,&quot;</span>);</div><div class="line">        j++;</div><div class="line">    }</div><div class="line"></div><div class="line"></div><div class="line">    free(cpus);</div><div class="line">    <span class="comment">// Uninitialize the perfmon module.</span></div><div class="line">    <a class="code" href="group__PerfMon.html#gac04bee1a0b2a5729a332c356c04a3392">perfmon_finalize</a>();</div><div class="line">    <a class="code" href="group__AffinityDomains.html#gad6adaffb2e3c72e3b588b87cb2d78cd5">affinity_finalize</a>();</div><div class="line">    <span class="comment">// Uninitialize the topology module.</span></div><div class="line">    <a class="code" href="group__CPUTopology.html#ga172163ecf6b848305009cd73ff3607b2">topology_finalize</a>();</div><div class="line">    <span class="keywordflow">return</span> 0;</div><div class="line">}</div></div><!-- fragment --><p> */ /*! </p>
</div></div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated on Thu Apr 19 2018 10:48:47 for LIKWID by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.11
</small></address>
</body>
</html>
